<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>B√∂‚ÄëMan</title>
  <style>
    :root { --bg:#0b0e13; --ink:#e9eaef; --accent:#2dd4bf; --danger:#ef4444; }
    * { box-sizing:border-box; -webkit-tap-highlight-color: transparent; }
    html, body { height:100%; margin:0; }
    body { background: radial-gradient(1200px 800px at 50% -10%, #121827 0, #0b0e13 60%);
           color:var(--ink); font: 16px/1.4 system-ui, -apple-system, Segoe UI, Roboto, Arial;
           display:flex; align-items:center; justify-content:center; }
    #wrap { width: min(96vw, 760px); display:flex; flex-direction:column; gap:10px; align-items:center; padding:10px; }
    header { display:flex; gap:.6rem; align-items:center; justify-content:space-between; width:100%; }
    h1 { margin:0; font-weight:800; letter-spacing:.5px; font-size:clamp(18px, 3.2vw, 24px); }
    #hud { display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
    .chip{ padding:.25rem .5rem; border-radius:999px; background:#111623; border:1px solid #1d2333; font-size:12px; opacity:.95 }
    #canvasWrap{ position:relative; width:100%; background:#0a0d14; border:1px solid #1c2231; border-radius:14px; padding:10px; }
    canvas{ width:100%; height:auto; display:block; border-radius:8px; background:#020409; touch-action:none; }
    #overlay{ position:absolute; inset:10px; border-radius:8px; display:flex; align-items:center; justify-content:center; pointer-events:none; }
    #overlay .panel{ pointer-events:auto; text-align:center; background:#0e1422cc; border:1px solid #1e2a46; backdrop-filter: blur(6px);
      padding:16px 14px; border-radius:12px; width:min(92%, 440px); }
    button.primary{ background:#1e2a46; color:#dbeafe; border:1px solid #2b3b67; border-radius:10px; padding:.7rem 1rem; font-weight:700; cursor:pointer; }
    button.primary:active{ transform:translateY(1px); }
    #controls{ width:100%; display:grid; grid-template-columns:1fr; gap:10px; margin-top:6px; }
    .pad{ background:#0e1422; border:1px solid #1d2538; border-radius:12px; padding:10px; display:grid;
      grid-template-columns:repeat(3,1fr); grid-template-rows:repeat(3,50px); gap:6px; }
    .pad button{ border:1px solid #223051; background:#121a2c; color:#cfe1ff; border-radius:10px; font-weight:700; font-size:16px; }
    .pad button:active{ transform:translateY(1px); }
    .kbbar{ background:#0e1422; border:1px solid #1d2538; border-radius:12px; padding:8px; display:grid;
      grid-template-columns:repeat(4,1fr); gap:6px; }
    .kbbar button{ border:1px solid #223051; background:#0f1627; color:#e6edff; border-radius:8px; font-weight:700; font-size:15px; padding:.6rem 0; }
    .ghost-legend{ display:flex; gap:8px; align-items:center; }
    .badge{ width:14px; height:14px; border-radius:50%; display:inline-block; }
    .badge.fly{ background:#95a4ff; }
    .badge.heart{ background:purple; }
    .badge.boe{ background:#8ef; border:1px dashed #aef; }
    footer{ opacity:.8; font-size:12px; }
    @media (min-width: 720px) {
      .pad { grid-template-rows:repeat(3,60px); }
    }
  </style>
</head>
<body>
  <div id="wrap">
    <header>
      <h1>üåÄ B√∂‚ÄëMan</h1>
      <div id="hud">
        <div class="chip">Punkte: <span id="score">0</span></div>
        <div class="chip">Leben: <span id="lives">3</span></div>
        <div class="chip ghost-legend">
          <span class="badge fly"></span> Fliegen
          <span class="badge boe"></span> ‚ÄúB√∂‚Äù
          <span class="badge heart"></span> ‚ù§Ô∏é
        </div>
      </div>
    </header>

    <div id="canvasWrap">
      <canvas id="game" width="448" height="528" aria-label="B√∂-Man Spielfeld"></canvas>
      <div id="overlay">
        <div class="panel">
          <h2 id="ovTitle" style="margin:.2rem 0 .6rem">B√∂‚ÄëMan</h2>
          <p id="ovText" style="margin:0 0 .9rem; opacity:.9">
            Sammle alle <b>Blumen</b>. Powerups sind <b>‚ÄúB√∂‚Äù</b> & <b>violette Herzen</b>.
            H√ºte dich vor <b>Fliegen</b>!<br/>
            <small>Mobil: D‚ÄëPad oder Pfeiltasten‚ÄëLeiste ‚Ä¢ Desktop: Pfeiltasten ‚Ä¢ Pause: P</small>
          </p>
          <button id="btnStart" class="primary">Start</button>
        </div>
      </div>
    </div>

    <div id="controls" aria-hidden="false">
      <div class="pad" id="pad">
        <div></div><button data-dir="up" aria-label="Hoch">‚ñ≤</button><div></div>
        <button data-dir="left" aria-label="Links">‚óÄ</button><div></div><button data-dir="right" aria-label="Rechts">‚ñ∂</button>
        <div></div><button data-dir="down" aria-label="Runter">‚ñº</button><div></div>
      </div>
      <div class="kbbar" id="kbbar" aria-label="Pfeiltasten (mobil)">
        <button data-dir="left" aria-label="Links">‚Üê</button>
        <button data-dir="up" aria-label="Hoch">‚Üë</button>
        <button data-dir="down" aria-label="Runter">‚Üì</button>
        <button data-dir="right" aria-label="Rechts">‚Üí</button>
      </div>
    </div>

    <footer>Tippen/Wischen zum Steuern ‚Ä¢ Pfeiltasten am Desktop ‚Ä¢ Pause: P</footer>
  </div>

<script>
(() => {
  const TILE=16, ROWS=33, COLS=28, SPEED=1.2, FLY_SPEED=0.95, FRAMERATE=60,
        FLOWER_SCORE=10, POWER_SCORE=50, FRIGHT_TIME=8*FRAMERATE, SHIELD_TIME=6*FRAMERATE;
  const canvas=document.getElementById('game'), ctx=canvas.getContext('2d'),
        scoreEl=document.getElementById('score'), livesEl=document.getElementById('lives'),
        overlay=document.getElementById('overlay'), btnStart=document.getElementById('btnStart'),
        ovTitle=document.getElementById('ovTitle'), ovText=document.getElementById('ovText');
  const desired={x:0,y:0}; function setDirection(d){desired.x=d==='left'?-1:d==='right'?1:0; desired.y=d==='up'?-1:d==='down'?1:0;}
  let touchStart=null;
  canvas.addEventListener('touchstart', e=>{const t=e.changedTouches[0]; touchStart={x:t.clientX,y:t.clientY};},{passive:true});
  canvas.addEventListener('touchend', e=>{ if(!touchStart) return; const t=e.changedTouches[0], dx=t.clientX-touchStart.x, dy=t.clientY-touchStart.y;
    const ax=Math.abs(dx), ay=Math.abs(dy); if(Math.max(ax,ay)>20){ if(ax>ay) setDirection(dx>0?'right':'left'); else setDirection(dy>0?'down':'up'); } touchStart=null; });
  function hookButtons(id){ const el=document.getElementById(id); el.addEventListener('click', e=>{ const dir=e.target.getAttribute('data-dir'); if(dir) setDirection(dir); }); }
  hookButtons('pad'); hookButtons('kbbar');
  addEventListener('keydown', e=>{ if(e.key==='ArrowUp'||e.key==='w') setDirection('up'); if(e.key==='ArrowDown'||e.key==='s') setDirection('down');
    if(e.key==='ArrowLeft'||e.key==='a') setDirection('left'); if(e.key==='ArrowRight'||e.key==='d') setDirection('right'); if(e.key.toLowerCase()==='p') togglePause(); });
  const M=["1111111111111111111111111111","1000000000110000000000000001","1011110110110111011110111101","1010000100000100010000100001","1010111111110111010111111101","1000100000000100010000000001","1111101111011111011111011101","1000001000010000000001000001","1011101011110111111101011101","1000101000000100000001000101","1110101111011111011110101111","1000100000010000000000000001","1011111111010111111111111101","1000000000010100000000000101","1011110111110101111110110101","1010000100000000000000100101","1010111101111111110111100101","1000100001000220010000000101","1110101111011111011110110101","1000101000000100000001000101","1011101011110111111101011101","1000001000010000000001000001","1011110111011111011101111101","1000000000000100000000000001","1011111111110111111111111101","1010000000000000000000000101","1010111111111111111111100101","1000100000000000000000100101","1110101111011111011110101111","1000100000010000000000000001","1011111111010111111111111101","1000000000010000000000000001","1111111111111111111111111111"].map(r=>r.split('').map(Number));
  const warpLeft={r:17,c:0}, warpRight={r:17,c:COLS-1};
  let score=0, lives=3, paused=true, running=false, win=false, frame=0;
  const flowers=new Set(), powerups=[], boPopups=[], flies=[], player={ x:14*TILE+TILE/2, y:23*TILE+TILE/2, dir:{x:0,y:0}, powerTimer:0, shieldTimer:0 };
  function rcKey(r,c){return r+','+c;} function isOpen(r,c){return M[r] && (M[r][c]===0 || M[r][c]===2);}
  function resetLevel(){
    flowers.clear(); powerups.length=0; flies.length=0;
    for(let r=1;r<ROWS-1;r++) for(let c=1;c<COLS-1;c++) if(isOpen(r,c) && M[r][c]!==2){ if(r===warpLeft.r && (c===warpLeft.c || c===warpRight.c)) continue; flowers.add(rcKey(r,c)); }
    [{r:1,c:1,type:'boe'},{r:1,c:COLS-2,type:'heart'},{r:ROWS-2,c:1,type:'heart'},{r:ROWS-2,c:COLS-2,type:'boe'},{r:17,c:5,type:'boe'},{r:17,c:22,type:'heart'}]
      .forEach(p=>powerups.push({...p,active:true}));
    [{r:17,c:13},{r:17,c:14},{r:17,c:15},{r:17,c:12}].forEach((s,i)=>flies.push({x:s.c*TILE+TILE/2,y:s.r*TILE+TILE/2,dir:{x:i%2?1:-1,y:0},state:'normal',respawn:0}));
    player.x=14*TILE+TILE/2; player.y=23*TILE+TILE/2; player.dir={x:0,y:0}; desired.x=0; desired.y=0; player.powerTimer=0; player.shieldTimer=0;
    score=0; lives=3; win=false; updateHUD();
  }
  function updateHUD(){ scoreEl.textContent=score; livesEl.textContent=lives; }
  function tileAt(x,y){ return {r:Math.floor(y/TILE), c:Math.floor(x/TILE)}; }
  function centerOf(rc){ return {x: rc.c*TILE+TILE/2, y: rc.r*TILE+TILE/2}; }
  function aligned(v){ return Math.abs((v%TILE)-TILE/2)<0.2; }
  function chooseFlyDir(f){
    const rc=tileAt(f.x,f.y); if(!aligned(f.x)||!aligned(f.y)) return;
    const cand=[{x:1,y:0},{x:-1,y:0},{x:0,y:1},{x:0,y:-1}], opts=[];
    for(const d of cand){ if(f.dir && d.x===-f.dir.x && d.y===-f.dir.y) continue; const nr=rc.r+d.y, nc=rc.c+d.x; if(isOpen(nr,nc)) opts.push(d); }
    if(!opts.length){ f.dir.x*=-1; f.dir.y*=-1; return; }
    if(f.state==='normal'){
      const target={x:player.x,y:player.y};
      opts.sort((a,b)=>{ const ca=centerOf({r:rc.r+a.y,c:rc.c+a.x}), cb=centerOf({r:rc.r+b.y,c:rc.c+b.x});
        const da=(ca.x-target.x)**2+(ca.y-target.y)**2, db=(cb.x-target.x)**2+(cb.y-target.y)**2; return da-db; });
      f.dir=opts[0];
    } else if (f.state==='fright'){
      f.dir=opts[Math.floor(Math.random()*opts.length)];
    } else {
      const target=centerOf({r:17,c:14});
      opts.sort((a,b)=>{ const ca=centerOf({r:rc.r+a.y,c:rc.c+a.x}), cb=centerOf({r:rc.r+b.y,c:rc.c+b.x});
        const da=(ca.x-target.x)**2+(ca.y-target.y)**2, db=(cb.x-target.x)**2+(cb.y-target.y)**2; return da-db; });
      f.dir=opts[0];
    }
  }
  function eatCheck(){
    const rc=tileAt(player.x,player.y), key=rcKey(rc.r,rc.c);
    if(flowers.has(key)){ flowers.delete(key); score+=FLOWER_SCORE; boPopups.push({x:player.x,y:player.y-6,vy:-0.4,life:40,text:'B√∂'}); if(flowers.size===0){win=true; endRound(true);} }
    for (const p of powerups){
      if(!p.active) continue;
      if(rc.r===p.r && rc.c===p.c){
        p.active=false; score+=POWER_SCORE;
        if(p.type==='boe'){ player.powerTimer=FRIGHT_TIME; for(const f of flies) if(f.state==='normal') f.state='fright'; }
        else { player.shieldTimer=SHIELD_TIME; }
        boPopups.push({x:player.x,y:player.y-8,vy:-0.5,life:50,text:p.type==='boe'?'B√ñ!':'‚ù§'});
      }
    }
  }
  function collide(a,b,rad=7){ const dx=a.x-b.x, dy=a.y-b.y; return (dx*dx+dy*dy) < rad*rad; }
  function handleCollisions(){
    for(const f of flies){
      if(collide(player,f,10)){
        if(player.powerTimer>0 && f.state!=='eyes'){ f.state='eyes'; score+=200; boPopups.push({x:f.x,y:f.y-8,vy:-0.5,life:50,text:'B√∂!'}); }
        else if(player.shieldTimer>0){ f.dir.x*=-1; f.dir.y*=-1; }
        else { loseLife(); return; }
      }
    }
  }
  function loseLife(){
    lives--; updateHUD(); if(lives<=0){ endRound(false); return; }
    player.x=14*TILE+TILE/2; player.y=23*TILE+TILE/2; player.dir={x:0,y:0}; desired.x=0; desired.y=0;
    for(const f of flies){ f.x=14*TILE+TILE/2; f.y=17*TILE+TILE/2; f.dir={x:1,y:0}; f.state='normal'; }
    player.powerTimer=0; player.shieldTimer=0; pauseOverlay('Autsch!','Noch '+lives+' Leben. Dr√ºcke Start.');
  }
  function pauseOverlay(t,html){ ovTitle.textContent=t; ovText.innerHTML=html; overlay.hidden=false; paused=true; }
  function endRound(v){ paused=true; running=false; overlay.hidden=false; if(v){ ovTitle.textContent='Gewonnen!'; ovText.innerHTML='Alle Blumen gesammelt. Punktestand: <b>'+score+'</b>'; }
    else { ovTitle.textContent='Game Over'; ovText.innerHTML='Versuch es nochmal! Punktestand: <b>'+score+'</b>'; } }
  function togglePause(){ if(!running) return; paused=!paused; overlay.hidden=!paused; if(paused){ ovTitle.textContent='Pause'; ovText.innerHTML='Tippe <b>Start</b>, um fortzufahren.'; } }
  btnStart.addEventListener('click', ()=>{ overlay.hidden=true; if(!running){ resetLevel(); running=true; paused=false; } else paused=false; });
  pauseOverlay('B√∂‚ÄëMan','Sammle alle <b>Blumen</b>. Powerups sind <b>‚ÄúB√∂‚Äù</b> (macht Fliegen √§ngstlich) & <b>‚ù§</b> (Schild).');
  function step(){ frame++; if(!paused){ update(); draw(); } else { draw(); } requestAnimationFrame(step); } requestAnimationFrame(step);
  function update(){
    if(aligned(player.x)&&aligned(player.y)){
      const rc=tileAt(player.x,player.y);
      if(rc.r===warpLeft.r && rc.c===warpLeft.c) player.x=(warpRight.c-1)*TILE + TILE/2;
      if(rc.r===warpRight.r && rc.c===warpRight.c) player.x=(warpLeft.c+1)*TILE + TILE/2;
      if(desired.x||desired.y){ const nr=rc.r+desired.y, nc=rc.c+desired.x; if(isOpen(nr,nc)) player.dir={x:desired.x,y:desired.y}; }
      const nr=rc.r+player.dir.y, nc=rc.c+player.dir.x; if(!isOpen(nr,nc)) player.dir={x:0,y:0};
    }
    player.x += player.dir.x * SPEED; player.y += player.dir.y * SPEED;
    if(player.powerTimer>0){ player.powerTimer--; if(player.powerTimer===0){ for(const f of flies) if(f.state==='fright') f.state='normal'; } }
    if(player.shieldTimer>0) player.shieldTimer--;
    for(const f of flies){
      if(f.state==='eyes'){
        if(aligned(f.x)&&aligned(f.y)) chooseFlyDir(f);
        f.x += (f.dir.x||0) * (FLY_SPEED*1.25); f.y += (f.dir.y||0) * (FLY_SPEED*1.25);
        const rc=tileAt(f.x,f.y); if(rc.r===17 && rc.c>=13 && rc.c<=15){ f.state='normal'; f.dir={x:(Math.random()<0.5?-1:1), y:0}; }
      } else {
        if(aligned(f.x)&&aligned(f.y)) chooseFlyDir(f);
        const spd=FLY_SPEED * (player.powerTimer>0 ? 0.8 : 1);
        f.x += (f.dir.x||0) * spd; f.y += (f.dir.y||0) * spd;
      }
      const rc=tileAt(f.x,f.y);
      if(rc.r===warpLeft.r && rc.c===warpLeft.c) f.x=(warpRight.c-1)*TILE + TILE/2;
      if(rc.r===warpRight.r && rc.c===warpRight.c) f.x=(warpLeft.c+1)*TILE + TILE/2;
    }
    eatCheck(); handleCollisions();
    for(const b of boPopups){ b.y += b.vy; b.life--; } while(boPopups.length && boPopups[0].life<=0) boPopups.shift();
  }
  function draw(){
    ctx.clearRect(0,0,canvas.width,canvas.height);
    drawMaze(); drawCollectibles(); drawPlayer(); drawFlies(); drawPopups();
  }
  function drawMaze(){
    ctx.strokeStyle='#203152'; ctx.lineWidth=2;
    for(let r=0;r<ROWS;r++) for(let c=0;c<COLS;c++) if(M[r][c]===1){ ctx.strokeRect(c*TILE+2, r*TILE+2, TILE-4, TILE-4); }
    ctx.strokeStyle='#33476f'; ctx.strokeRect(12*TILE+2,16*TILE+2,4*TILE-4,3*TILE-4);
  }
  function drawFlower(x,y){
    ctx.save(); ctx.translate(x,y); ctx.fillStyle='#ffd166';
    for(let i=0;i<6;i++){ const a=i*Math.PI/3; ctx.beginPath(); ctx.arc(Math.cos(a)*3,Math.sin(a)*3,1.8,0,Math.PI*2); ctx.fill(); }
    ctx.fillStyle='#8bd17c'; ctx.beginPath(); ctx.arc(0,0,1.6,0,Math.PI*2); ctx.fill(); ctx.restore();
  }
  function drawCollectibles(){
    for(const key of flowers){ const [r,c]=key.split(',').map(Number); drawFlower(c*TILE+TILE/2, r*TILE+TILE/2); }
    for(const p of powerups){
      if(!p.active) continue; const x=p.c*TILE+TILE/2, y=p.r*TILE+TILE/2;
      if(p.type==='boe'){
        ctx.save(); ctx.translate(x,y); ctx.fillStyle='#bfe6ff'; ctx.beginPath();
        if(ctx.roundRect) ctx.roundRect(-7,-6,14,12,4); else ctx.rect(-7,-6,14,12); ctx.fill();
        ctx.beginPath(); ctx.moveTo(-3,6); ctx.lineTo(-1,9); ctx.lineTo(2,6); ctx.closePath(); ctx.fill();
        ctx.fillStyle='#0b1630'; ctx.font='bold 8px system-ui'; ctx.textAlign='center'; ctx.textBaseline='middle'; ctx.fillText('B√∂',0,0);
        ctx.restore();
      } else {
        ctx.save(); ctx.translate(x,y); ctx.fillStyle='purple';
        ctx.beginPath(); ctx.moveTo(0,5); ctx.bezierCurveTo(8,-2,6,-8,0,-3); ctx.bezierCurveTo(-6,-8,-8,-2,0,5); ctx.fill(); ctx.restore();
      }
    }
  }
  function drawPlayer(){
    ctx.save(); ctx.translate(player.x,player.y); ctx.fillStyle='#42a5ff'; ctx.beginPath(); ctx.arc(0,0,7.5,0,Math.PI*2); ctx.fill();
    ctx.fillStyle='#ffffff'; ctx.beginPath(); ctx.ellipse(2,-1,3.2,3.6,0,0,Math.PI*2); ctx.fill();
    ctx.fillStyle='#0b1e39'; ctx.beginPath(); ctx.arc(3,-1,1.5,0,Math.PI*2); ctx.fill();
    if(player.dir.x||player.dir.y){ ctx.globalCompositeOperation='destination-out'; ctx.beginPath(); const ang=Math.atan2(player.dir.y,player.dir.x);
      ctx.moveTo(0,0); ctx.arc(0,0,7.6,ang-0.35,ang+0.35); ctx.closePath(); ctx.fill(); ctx.globalCompositeOperation='source-over'; }
    if(player.shieldTimer>0){ ctx.strokeStyle='#d3a6ff'; ctx.lineWidth=1.5+(player.shieldTimer%20)/20; ctx.beginPath(); ctx.arc(0,0,9.5,0,Math.PI*2); ctx.stroke(); }
    ctx.restore();
  }
  function drawFlies(){
    for(const f of flies){
      ctx.save(); ctx.translate(f.x,f.y);
      const base=(f.state==='fright')?'#9ad1ff':(f.state==='eyes')?'#d0d7e2':'#9aa8ff';
      ctx.fillStyle=base; ctx.beginPath(); ctx.ellipse(0,1,5.5,4.5,0,0,Math.PI*2); ctx.fill();
      ctx.beginPath(); ctx.arc(0,-3,3,0,Math.PI*2); ctx.fill();
      ctx.globalAlpha=0.9; ctx.fillStyle='#cfe7ff'; const wing=Math.sin(frame/6)*2;
      ctx.beginPath(); ctx.ellipse(-4,-6+wing,3,4,-0.6,0,Math.PI*2); ctx.fill();
      ctx.beginPath(); ctx.ellipse(4,-6-wing,3,4,0.6,0,Math.PI*2); ctx.fill();
      ctx.globalAlpha=1; ctx.restore();
    }
  }
  function drawPopups(){
    for(const b of boPopups){
      ctx.save(); ctx.translate(b.x,b.y); ctx.globalAlpha=Math.max(0,b.life/50);
      ctx.fillStyle='#eaf2ff'; ctx.font='bold 10px system-ui'; ctx.textAlign='center'; ctx.textBaseline='middle';
      ctx.fillText(b.text,0,0); ctx.restore();
    }
  }
  resetLevel(); overlay.hidden=false; paused=true; running=false;
})();</script>
</body>
</html>